<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PathFinder AI - Mindmap Mode</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
        window.mermaid = mermaid; // Make global
    </script>

    <style>
        body { font-family: 'Poppins', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Markdown Styles */
        .markdown-body h2 { font-size: 1.5rem; font-weight: bold; color: #1d4ed8; margin-top: 1rem; margin-bottom: 0.5rem; }
        .markdown-body p { margin-bottom: 0.8rem; line-height: 1.6; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        .markdown-body strong { color: #1e40af; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex flex-col">

    <div class="h-16 bg-white border-b flex items-center px-6 justify-between shadow-sm">
        <div class="flex items-center gap-2 font-bold text-xl text-blue-600">
            <i class="fa-solid fa-brain"></i> PathFinder AI
        </div>
        <button onclick="location.reload()" class="text-gray-500 hover:text-red-500 text-sm">
            <i class="fa-solid fa-rotate-right"></i> Reset
        </button>
    </div>

    <div id="chat-box" class="flex-1 overflow-y-auto p-6 space-y-6">
        <div class="flex justify-start">
            <div class="bg-white border p-4 rounded-2xl max-w-[80%] shadow-sm">
                Hi! I create visual Learning Maps. What do you want to learn?
            </div>
        </div>
    </div>

    <div class="p-4 bg-white border-t">
        <div class="max-w-4xl mx-auto relative flex items-center gap-2">
            <input type="text" id="user-input"
                class="w-full bg-gray-100 rounded-full pl-6 pr-14 py-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Ex: Learn ReactJS, History of Vietnam..."
                onkeypress="handleEnter(event)">
            <button onclick="sendMessage()"
                class="absolute right-2 bg-blue-600 text-white w-10 h-10 rounded-full flex items-center justify-center hover:scale-110 transition">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script>
        const API_URL = "https://pathfinder-swgh.onrender.com";

        async function sendMessage() {
            const inputField = document.getElementById("user-input");
            const message = inputField.value.trim();
            if (!message) return;

            // Render User Message
            addMessage("user", message);
            inputField.value = "";
            showLoading(true);

            try {
                // Call API
                const response = await fetch(`${API_URL}/chat`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();
                showLoading(false);

                // --- X·ª¨ L√ù D·ªÆ LI·ªÜU M·ªöI ---
                // Data tr·∫£ v·ªÅ gi·ªù l√†: { reply: "...", plan: { markdown: "...", mermaid: "..." } }

                if (data.plan && data.plan.markdown) {
                    renderRichContent(data.plan.markdown, data.plan.mermaid);
                } else {
                    addMessage("bot", data.reply || "Error processing request.");
                }

            } catch (error) {
                showLoading(false);
                addMessage("bot", "Connection error.");
            }
        }

        function addMessage(sender, text) {
            const chatBox = document.getElementById("chat-box");
            const div = document.createElement("div");
            div.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} fade-in`;
            div.innerHTML = `
                <div class="max-w-[85%] p-4 rounded-2xl shadow-sm ${
                    sender === 'user' ? 'bg-blue-600 text-white' : 'bg-white border'
                }">
                    ${text}
                </div>`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- H√ÄM RENDER QUAN TR·ªåNG NH·∫§T ---
        async function renderRichContent(markdownText, mermaidCode) {
            const chatBox = document.getElementById("chat-box");
            const uniqueId = "mermaid-" + Math.random().toString(36).substr(2, 9);

            const div = document.createElement("div");
            div.className = "flex justify-start fade-in w-full";
            div.innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-blue-100 w-full max-w-3xl">
                    <div class="mb-6 border-b pb-4">
                        <h3 class="font-bold text-gray-500 text-sm mb-2 uppercase tracking-wide">üß† Knowledge Map</h3>
                        <div class="mermaid flex justify-center bg-blue-50 p-4 rounded-xl overflow-x-auto">
                            ${mermaidCode}
                        </div>
                    </div>

                    <div class="markdown-body text-gray-700 text-sm">
                        ${marked.parse(markdownText)}
                    </div>
                </div>`;

            chatBox.appendChild(div);

            // K√≠ch ho·∫°t v·∫Ω Mindmap
            try {
                await window.mermaid.run();
            } catch (e) { console.log("Mermaid error", e); }

            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function showLoading(isLoading) {
            const chatBox = document.getElementById("chat-box");
            const existing = document.getElementById("loading");
            if(isLoading && !existing) {
                const div = document.createElement("div");
                div.id = "loading";
                div.innerHTML = `<div class="flex justify-center p-4"><span class="animate-bounce text-2xl">ü§î</span></div>`;
                chatBox.appendChild(div);
                chatBox.scrollTop = chatBox.scrollHeight;
            } else if(!isLoading && existing) existing.remove();
        }

        function handleEnter(e) { if (e.key === "Enter") sendMessage(); }
    </script>
</body>
</html>