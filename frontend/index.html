<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyBot - AI Learning Companion</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: false, theme: 'default' });
        window.mermaid = mermaid;
    </script>

    <style>
        body { font-family: 'Poppins', sans-serif; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }

        /* Markdown Styles within Chat */
        .markdown-body h2 { font-size: 1.25rem; font-weight: 700; color: #1d4ed8; margin-top: 1rem; margin-bottom: 0.5rem; }
        .markdown-body h3 { font-size: 1.1rem; font-weight: 600; color: #2563eb; margin-top: 0.8rem; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.8rem; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 0.8rem; }
        .markdown-body li { margin-bottom: 0.25rem; }
        .markdown-body strong { color: #1e40af; }
        .markdown-body p { margin-bottom: 0.8rem; line-height: 1.6; }
    </style>
</head>
<body class="bg-white text-gray-800 h-screen flex flex-col overflow-hidden">

    <div id="chat-interface" class="flex h-screen w-full">

        <div class="w-64 bg-gray-50 border-r border-gray-200 flex flex-col hidden md:flex">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <span class="font-bold text-gray-700">My Sessions</span>
                <button onclick="startNewChat()" class="text-blue-600 hover:bg-blue-100 p-2 rounded-full transition" title="New Chat">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>
            <div id="thread-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                </div>
            <button onclick="clearAllData()" class="p-4 text-gray-500 hover:text-red-500 text-sm flex items-center gap-2 border-t">
                <i class="fa-solid fa-trash"></i> Reset All History
            </button>
        </div>

        <div class="flex-1 flex flex-col bg-white relative">
            <div class="h-16 border-b border-gray-100 flex items-center px-6 justify-between bg-white shadow-sm z-10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <div>
                        <h2 class="font-bold text-gray-800">Learning Assistant</h2>
                        <span class="text-xs text-green-500 flex items-center gap-1">
                            <span class="w-2 h-2 bg-green-500 rounded-full"></span> Online
                        </span>
                    </div>
                </div>
            </div>

            <div id="chat-box" class="flex-1 overflow-y-auto p-6 space-y-6 bg-gray-50 pb-24">
                <div class="flex justify-start fade-in">
                    <div class="max-w-[85%] p-4 rounded-2xl shadow-sm text-sm leading-relaxed bg-white text-gray-800 border border-gray-100 rounded-bl-none">
                        Hello! I'm here to help you learn. Try asking: <br>
                        <strong>"I want to learn Python in 4 months"</strong>
                    </div>
                </div>
            </div>

            <div class="absolute bottom-0 w-full bg-white border-t border-gray-100 p-4">
                <div class="max-w-4xl mx-auto relative flex items-center gap-2">
                    <input type="text" id="user-input"
                        class="w-full bg-gray-100 text-gray-800 rounded-full pl-6 pr-14 py-4 focus:outline-none focus:ring-2 focus:ring-blue-500 transition shadow-inner"
                        placeholder="Type your goal (e.g., Learn SQL)..."
                        onkeypress="handleEnter(event)">

                    <button onclick="sendMessage()"
                        class="absolute right-2 bg-blue-600 hover:bg-blue-700 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg transition hover:scale-110">
                        <i class="fa-solid fa-paper-plane text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // Sử dụng đúng URL Server của bạn
        const API_URL = "https://pathfinder-swgh.onrender.com";

        // --- STATE MANAGEMENT ---
        let currentThreadId = null;
        let threads = [];

        // Load local storage
        try {
            const stored = localStorage.getItem('pathfinder_threads');
            if (stored) threads = JSON.parse(stored);
        } catch (e) { threads = []; }

        document.addEventListener("DOMContentLoaded", () => {
            if (!currentThreadId) startNewChat();
            renderThreadList();
        });

        // --- CORE FUNCTIONS ---

        function startNewChat() {
            currentThreadId = "thread_" + Date.now();
            const newThread = {
                id: currentThreadId,
                title: "New Session",
                date: new Date().toLocaleDateString()
            };
            threads.unshift(newThread);
            saveThreads();

            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = '';
            addMessage("bot", "Hello! Tell me what you want to learn and your timeframe.");
            renderThreadList();
        }

        async function sendMessage(manualMessage = null, isHiddenCommand = false) {
            const inputField = document.getElementById("user-input");
            const message = manualMessage || inputField.value.trim();

            if (!message) return;

            // 1. Nếu không phải lệnh ẩn (như vẽ map), thì hiện tin nhắn user lên
            if (!isHiddenCommand) {
                addMessage("user", message);
                if (!manualMessage) inputField.value = "";
            } else {
                // Nếu là lệnh ẩn, hiện loading kiểu khác hoặc thông báo nhỏ
                // Ở đây ta cứ hiện loading bình thường để user biết đang xử lý
            }

            // 2. Loading State
            showTyping(true);
            updateThreadTitle(currentThreadId, message);

            try {
                // 3. Gửi lên Server
                const response = await fetch(`${API_URL}/chat`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message: message,
                        thread_id: currentThreadId
                    })
                });

                const data = await response.json();
                showTyping(false);

                if (!data || data.status === "error") {
                    addMessage("bot", "⚠️ Server Error: " + (data?.reply || "Unknown"));
                } else {
                    // --- XỬ LÝ PHẢN HỒI ---

                    // A. Nếu có Text trả lời
                    if (data.reply) {
                        addMessage("bot", data.reply);

                        // LOGIC QUAN TRỌNG:
                        // Nếu tin nhắn dài (có vẻ là kế hoạch học tập), hiện nút gợi ý
                        // Tránh hiện nút khi user chỉ chào hỏi "Hello"
                        if (data.reply.length > 50 && !isHiddenCommand) {
                            renderActionButtons();
                        }
                    }

                    // B. Nếu Server trả về Map (do bấm nút visualize)
                    if (data.plan && (data.plan.mermaid || data.plan.markdown)) {
                        renderRichPlan(data.plan);
                    }

                    // C. Nếu Server trả về Quiz (do bấm nút quiz)
                    if (data.quiz) {
                        renderQuiz(data.quiz);
                    }
                }

            } catch (error) {
                showTyping(false);
                addMessage("bot", "❌ Connection failed. Is the backend running?");
                console.error(error);
            }
        }

        // --- CÁC NÚT CHỨC NĂNG (THEO Ý BẠN) ---

        function renderActionButtons() {
            const chatBox = document.getElementById("chat-box");

            const div = document.createElement("div");
            div.className = "flex gap-3 mt-2 fade-in ml-2 mb-4";

            // Nút 1: Visualize
            // Nút 2: Quiz
            div.innerHTML = `
                <button onclick="triggerMap(this)"
                    class="flex items-center gap-2 bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-2 rounded-full text-sm font-medium transition shadow-sm border border-blue-200">
                    <i class="fa-solid fa-map"></i> Draw Roadmap
                </button>

                <button onclick="triggerQuiz(this)"
                    class="flex items-center gap-2 bg-purple-100 hover:bg-purple-200 text-purple-700 px-4 py-2 rounded-full text-sm font-medium transition shadow-sm border border-purple-200">
                    <i class="fa-solid fa-list-check"></i> Take a Quiz
                </button>
            `;

            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function triggerMap(btn) {
            // Ẩn nút đi để tránh bấm nhiều lần
            btn.parentElement.remove();
            // Gửi lệnh ngầm
            sendMessage("Visualize the above plan as a detailed mermaid mindmap", true);
        }

        function triggerQuiz(btn) {
            // Ẩn nút đi
            btn.parentElement.remove();
            // Gửi lệnh ngầm
            sendMessage("Create a multiple choice quiz based on the plan above", true);
        }

        // --- UI RENDERING HELPERS ---

        function addMessage(sender, text) {
            const chatBox = document.getElementById("chat-box");
            const isUser = sender === "user";

            const div = document.createElement("div");
            div.className = `flex ${isUser ? 'justify-end' : 'justify-start'} fade-in`;

            div.innerHTML = `
                <div class="max-w-[85%] p-4 rounded-2xl shadow-sm text-sm leading-relaxed ${
                    isUser ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white text-gray-800 border border-gray-100 rounded-bl-none'
                }">
                    <div class="markdown-body" style="${isUser ? 'color:white' : ''}">
                        ${marked.parse(text)}
                    </div>
                </div>`;

            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function renderRichPlan(plan) {
            const chatBox = document.getElementById("chat-box");
            const planCard = document.createElement("div");
            planCard.className = "flex justify-start fade-in w-full mt-4";

            // Lấy code mermaid
            const mermaidCode = plan.mermaid || plan.markdown;

            planCard.innerHTML = `
                <div class="bg-white p-2 rounded-xl shadow-lg border border-gray-200 w-full max-w-3xl overflow-hidden">
                    <div class="flex items-center justify-between px-4 py-2 bg-gray-50 border-b">
                        <h3 class="font-bold text-gray-700 text-sm"><i class="fa-solid fa-sitemap"></i> Learning Roadmap</h3>
                    </div>
                    <div class="mermaid flex justify-center p-4 overflow-x-auto">
                        ${mermaidCode}
                    </div>
                </div>`;

            chatBox.appendChild(planCard);

            if (window.mermaid) {
                try { await window.mermaid.run(); } catch(e) { console.log(e); }
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function renderQuiz(quizContent) {
            const chatBox = document.getElementById("chat-box");
            const quizCard = document.createElement("div");
            quizCard.className = "flex justify-start fade-in w-full mt-4";

            // Xử lý nếu quiz là object JSON
            let contentToShow = typeof quizContent === 'object' ? JSON.stringify(quizContent) : quizContent;

            quizCard.innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-purple-500 w-full max-w-3xl">
                    <div class="flex items-center justify-between mb-4 border-b pb-2">
                        <h3 class="text-lg font-bold text-purple-700 flex items-center gap-2">
                            <i class="fa-solid fa-clipboard-question"></i> Quiz Time
                        </h3>
                    </div>
                    <div class="markdown-body quiz-content text-gray-700 leading-relaxed">
                        ${marked.parse(contentToShow)}
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-100 text-right text-xs text-gray-400">
                        Type your answer (e.g. "1A, 2B")...
                    </div>
                </div>`;

            chatBox.appendChild(quizCard);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function showTyping(isLoading) {
            const chatBox = document.getElementById("chat-box");
            const existing = document.getElementById("typing-indicator");

            if (isLoading && !existing) {
                const div = document.createElement("div");
                div.id = "typing-indicator";
                div.className = "flex justify-start fade-in";
                div.innerHTML = `<div class="bg-gray-100 p-3 rounded-2xl rounded-bl-none flex gap-1 items-center ml-2 border border-gray-200"><span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span><span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-100"></span><span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-200"></span></div>`;
                chatBox.appendChild(div);
                chatBox.scrollTop = chatBox.scrollHeight;
            } else if (!isLoading && existing) {
                existing.remove();
            }
        }

        function saveThreads() {
            localStorage.setItem('pathfinder_threads', JSON.stringify(threads));
            renderThreadList();
        }

        function updateThreadTitle(id, firstMessage) {
            const thread = threads.find(t => t.id === id);
            if (thread && thread.title === "New Session") {
                thread.title = firstMessage.substring(0, 20) + "...";
                saveThreads();
            }
        }

        function renderThreadList() {
            const list = document.getElementById("thread-list");
            list.innerHTML = "";
            threads.forEach(t => {
                const isActive = t.id === currentThreadId;
                list.innerHTML += `
                    <div onclick="loadThread('${t.id}')"
                        class="p-3 rounded-lg cursor-pointer transition flex items-center justify-between gap-2 ${isActive ? 'bg-blue-100 text-blue-700' : 'hover:bg-gray-100 text-gray-600'}">
                        <span class="truncate text-sm font-medium">${t.title}</span>
                        <i onclick="deleteThread(event, '${t.id}')" class="fa-solid fa-trash text-xs text-gray-300 hover:text-red-500"></i>
                    </div>`;
            });
        }

        function loadThread(id) {
            currentThreadId = id;
            document.getElementById("chat-box").innerHTML = "";
            renderThreadList();
            addMessage("bot", "Session resumed.");
        }

        function deleteThread(e, id) {
            e.stopPropagation();
            if(confirm("Delete chat?")) {
                threads = threads.filter(t => t.id !== id);
                saveThreads();
                if(currentThreadId == id) startNewChat();
            }
        }

        function clearAllData() {
            if(confirm("Clear all history?")) {
                localStorage.removeItem('pathfinder_threads');
                location.reload();
            }
        }

        function handleEnter(e) {
            if (e.key === "Enter") sendMessage();
        }
    </script>
</body>
</html>