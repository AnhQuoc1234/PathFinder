<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyBot - AI Learning Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: false, theme: 'default' });
        window.mermaid = mermaid;
    </script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 10px; }
        .markdown-body h2 { font-size: 1.25rem; font-weight: 700; color: #1d4ed8; margin: 1rem 0 0.5rem; }
        .markdown-body h3 { font-size: 1.1rem; font-weight: 600; color: #2563eb; margin: 0.8rem 0; }
        .markdown-body ul, .markdown-body ol { padding-left: 1.5rem; margin-bottom: 0.8rem; }
        .markdown-body li { margin-bottom: 0.25rem; list-style: disc; }
        .markdown-body p { margin-bottom: 0.8rem; line-height: 1.6; }
    </style>
</head>
<body class="bg-white text-gray-800 h-screen flex flex-col overflow-hidden">

    <div id="landing-page" class="flex-1 flex flex-col items-center justify-center p-6 text-center fade-in">
        <h1 class="text-5xl font-bold text-gray-900 mb-6">AI Learning <span class="text-blue-600">Companion ðŸŽ“</span></h1>
        <button onclick="startNewChat()" class="bg-blue-600 hover:bg-blue-700 text-white text-lg font-semibold py-4 px-8 rounded-full shadow-lg transition transform hover:scale-105">
            START LEARNING <i class="fa-solid fa-arrow-right ml-2"></i>
        </button>
    </div>

    <div id="chat-interface" class="hidden flex h-screen w-full">
        <div class="w-64 bg-gray-50 border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <span class="font-bold">My Sessions</span>
                <button onclick="startNewChat()" class="text-blue-600 hover:bg-blue-100 p-2 rounded-full"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div id="thread-list" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
            <button onclick="backToHome()" class="p-4 text-gray-500 hover:text-gray-800 border-t"><i class="fa-solid fa-arrow-left"></i> Home</button>
        </div>

        <div class="flex-1 flex flex-col bg-white">
            <div class="h-16 border-b flex items-center px-6 justify-between bg-white shadow-sm z-10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600"><i class="fa-solid fa-robot"></i></div>
                    <h2 class="font-bold">Learning Assistant</h2>
                </div>
                <button onclick="clearAllData()" class="text-xs text-red-400 hover:text-red-600 underline">Reset Data</button>
            </div>

            <div id="chat-box" class="flex-1 overflow-y-auto p-6 space-y-6 bg-gray-50"></div>

            <div class="p-4 bg-white border-t">
                <div class="max-w-4xl mx-auto relative flex items-center gap-2">
                    <input type="text" id="user-input" class="w-full bg-gray-100 rounded-full pl-6 pr-14 py-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type your goal..." onkeypress="handleEnter(event)">
                    <button onclick="sendMessage()" class="absolute right-2 bg-blue-600 hover:bg-blue-700 text-white w-10 h-10 rounded-full shadow-lg"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://pathfinder-swgh.onrender.com";
        let currentThreadId = null;
        let threads = [];
        let cachedPlan = null; // BIáº¾N QUAN TRá»ŒNG: DÃ¹ng Ä‘á»ƒ giáº¥u Map

        // --- INIT & NAVIGATION ---
        try { threads = JSON.parse(localStorage.getItem('pathfinder_threads') || "[]"); } catch (e) { threads = []; }

        function startNewChat() {
            currentThreadId = "thread_" + Date.now();
            threads.unshift({ id: currentThreadId, title: "New Session", date: new Date().toLocaleDateString() });
            saveThreads();
            toggleView(true);
            document.getElementById('chat-box').innerHTML = '';
            cachedPlan = null;
            addMessage("bot", "Hi! What do you want to learn today?");
            renderThreadList();
        }

        function toggleView(showChat) {
            document.getElementById('landing-page').classList.toggle('hidden', showChat);
            document.getElementById('chat-interface').classList.toggle('hidden', !showChat);
        }

        function loadThread(id) {
            currentThreadId = id;
            cachedPlan = null;
            toggleView(true);
            document.getElementById('chat-box').innerHTML = '';
            addMessage("bot", "Session loaded.");
            renderThreadList();
        }

        function backToHome() { toggleView(false); }

        function clearAllData() {
            if(confirm("Delete all history?")) { localStorage.removeItem('pathfinder_threads'); threads = []; backToHome(); }
        }

        // --- MAIN LOGIC ---

        async function sendMessage(manualMsg = null) {
            const input = document.getElementById("user-input");
            const msg = manualMsg || input.value.trim();
            if (!msg) return;

            addMessage("user", msg);
            if (!manualMsg) input.value = "";
            showTyping(true);
            updateThreadTitle(msg);

            try {
                const res = await fetch(`${API_URL}/chat`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: msg, thread_id: currentThreadId })
                });
                const data = await res.json();
                showTyping(false);

                if (data.status === "error") {
                    addMessage("bot", "âš ï¸ Error: " + (data.reply || "Server error"));
                    return;
                }

                // 1. HIá»†N TEXT TRÆ¯á»šC (Æ¯U TIÃŠN Sá» 1)
                if (data.reply) {
                    addMessage("bot", data.reply);
                }

                // 2. GIáº¤U MAP (Náº¾U CÃ“)
                // Thay vÃ¬ váº½ ngay, ta lÆ°u vÃ o cachedPlan
                if (data.plan) {
                    console.log("Map received but holding back...");
                    cachedPlan = data.plan;
                }

                // 3. HIá»†N NÃšT Báº¤M (Náº¾U CÃ“ TEXT HOáº¶C CÃ“ MAP ÄANG GIáº¤U)
                if (data.reply || cachedPlan) {
                    renderActionButtons();
                }

                // 4. CHá»ˆ Váº¼ QUIZ Náº¾U ÄÆ¯á»¢C YÃŠU Cáº¦U Cá»¤ THá»‚ (thÆ°á»ng lÃ  sau khi báº¥m nÃºt Quiz)
                if (data.quiz) {
                    renderQuiz(data.quiz);
                }

            } catch (err) {
                showTyping(false);
                addMessage("bot", "Connection failed. Please check your internet or server.");
            }
        }

        // --- ACTION BUTTONS (LOGIC Má»šI) ---
        function renderActionButtons() {
            const chatBox = document.getElementById("chat-box");
            // XÃ³a nÃºt cÅ© náº¿u cÃ³ Ä‘á»ƒ trÃ¡nh trÃ¹ng láº·p
            const oldBtns = chatBox.querySelectorAll(".action-buttons");
            oldBtns.forEach(b => b.remove());

            const div = document.createElement("div");
            div.className = "action-buttons flex gap-3 mt-2 fade-in ml-2 mb-4";

            div.innerHTML = `
                <button onclick="handleVisualize(this)" class="flex items-center gap-2 bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-2 rounded-full text-sm font-medium transition">
                    <i class="fa-solid fa-map"></i> Visualize Roadmap
                </button>
                <button onclick="handleQuiz(this)" class="flex items-center gap-2 bg-purple-100 hover:bg-purple-200 text-purple-700 px-4 py-2 rounded-full text-sm font-medium transition">
                    <i class="fa-solid fa-clipboard-question"></i> Take a Quiz
                </button>
            `;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Khi báº¥m nÃºt Visualize
        function handleVisualize(btn) {
            btn.parentElement.remove(); // XÃ³a nÃºt sau khi báº¥m

            if (cachedPlan) {
                // TRÆ¯á»œNG Há»¢P 1: Server Ä‘Ã£ gá»­i Map kÃ¨m Text rá»“i (Ä‘ang giáº¥u) -> LÃ´i ra váº½ ngay (SiÃªu nhanh)
                renderRichPlan(cachedPlan);
                cachedPlan = null; // XÃ³a cache
            } else {
                // TRÆ¯á»œNG Há»¢P 2: Server chÆ°a gá»­i Map -> Gá»­i lá»‡nh xin Map
                sendMessage("Generate a mermaid mindmap for the above plan");
            }
        }

        // Khi báº¥m nÃºt Quiz
        function handleQuiz(btn) {
            btn.parentElement.remove();
            sendMessage("Generate a quiz based on the plan");
        }

        // --- RENDER HELPERS ---
        function addMessage(sender, text) {
            const chatBox = document.getElementById("chat-box");
            const isUser = sender === "user";
            const div = document.createElement("div");
            div.className = `flex ${isUser ? 'justify-end' : 'justify-start'} fade-in`;
            div.innerHTML = `<div class="max-w-[85%] p-4 rounded-2xl shadow-sm text-sm ${isUser ? 'bg-blue-600 text-white' : 'bg-white border text-gray-800'}"><div class="markdown-body">${marked.parse(text)}</div></div>`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function renderRichPlan(plan) {
            const chatBox = document.getElementById("chat-box");
            const div = document.createElement("div");
            div.className = "w-full mt-4 fade-in";
            div.innerHTML = `
                <div class="bg-white p-4 rounded-xl shadow border border-blue-100">
                    <h3 class="font-bold text-gray-800 mb-2"><i class="fa-solid fa-map"></i> Roadmap</h3>
                    <div class="mermaid flex justify-center bg-blue-50 p-4 rounded">${plan.mermaid || plan.markdown}</div>
                </div>`;
            chatBox.appendChild(div);
            if (window.mermaid) await window.mermaid.run();
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function renderQuiz(quiz) {
            const chatBox = document.getElementById("chat-box");
            const div = document.createElement("div");
            div.className = "w-full mt-4 fade-in";
            div.innerHTML = `<div class="bg-white p-6 rounded-xl shadow border-l-4 border-purple-500"><h3 class="font-bold text-purple-700 mb-2">Quiz Time</h3><div class="markdown-body">${marked.parse(quiz)}</div></div>`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function showTyping(show) {
            const existing = document.getElementById("typing");
            if (show && !existing) {
                const d = document.createElement("div"); d.id = "typing"; d.className = "flex fade-in ml-4 mb-4";
                d.innerHTML = `<div class="bg-gray-200 p-3 rounded-xl flex gap-1"><span class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></span><span class="w-2 h-2 bg-gray-500 rounded-full animate-bounce delay-75"></span><span class="w-2 h-2 bg-gray