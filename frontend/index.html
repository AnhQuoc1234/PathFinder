<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyBot - Personal Learning Assistant</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: false, theme: 'neutral' });
        window.mermaid = mermaid;
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Markdown Styles */
        .prose h2 { font-size: 1.25em; font-weight: 700; color: #1e3a8a; margin-top: 1em; margin-bottom: 0.5em; }
        .prose h3 { font-size: 1.1em; font-weight: 600; color: #2563eb; margin-top: 1em; margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .prose p { margin-bottom: 0.8em; line-height: 1.6; }
        .prose strong { color: #1e40af; font-weight: 600; }
        .prose blockquote { border-left: 4px solid #e5e7eb; padding-left: 1em; color: #4b5563; font-style: italic; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col overflow-hidden text-gray-800">

    <div id="intro-screen" class="flex-1 flex flex-col items-center justify-center p-6 text-center bg-white z-50">
        <div class="mb-8 p-6 bg-blue-50 rounded-full animate-pulse">
            <i class="fa-solid fa-graduation-cap text-6xl text-blue-600"></i>
        </div>
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4 tracking-tight">
            Master Any Subject
        </h1>
        <p class="text-lg text-gray-500 max-w-xl mb-10 leading-relaxed">
            I'll help you build a personalized study plan. Tell me what you want to learn and how much time you have.
        </p>

        <div class="w-full max-w-md space-y-3">
            <button onclick="startChat('I want to learn Python in 3 months')" class="w-full text-left p-4 rounded-xl border hover:border-blue-500 hover:shadow-md transition flex items-center gap-3 group bg-white">
                <span class="bg-blue-100 text-blue-600 w-8 h-8 rounded-lg flex items-center justify-center font-bold group-hover:bg-blue-600 group-hover:text-white transition">1</span>
                <span>"I want to learn Python in 3 months"</span>
            </button>
            <button onclick="startChat('Create a study plan for IELTS Band 7')" class="w-full text-left p-4 rounded-xl border hover:border-purple-500 hover:shadow-md transition flex items-center gap-3 group bg-white">
                <span class="bg-purple-100 text-purple-600 w-8 h-8 rounded-lg flex items-center justify-center font-bold group-hover:bg-purple-600 group-hover:text-white transition">2</span>
                <span>"Create a study plan for IELTS Band 7"</span>
            </button>
             <button onclick="startChat()" class="mt-6 bg-gray-900 text-white font-semibold py-3 px-8 rounded-full hover:bg-black transition shadow-lg w-full">
                Start a New Chat
            </button>
        </div>
    </div>

    <div id="app-interface" class="hidden flex h-full w-full max-w-7xl mx-auto bg-white shadow-2xl md:my-4 md:rounded-2xl overflow-hidden border border-gray-200">

        <div class="w-72 bg-gray-50 border-r border-gray-100 hidden md:flex flex-col">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center">
                <h2 class="font-bold text-gray-700">History</h2>
                <button onclick="resetChat()" class="text-xs text-gray-400 hover:text-red-500 transition">Clear All</button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto p-3 space-y-2">
                </div>
            <div class="p-4 border-t border-gray-100">
                <button onclick="window.location.reload()" class="flex items-center gap-2 text-gray-500 hover:text-gray-900 transition text-sm">
                    <i class="fa-solid fa-arrow-left"></i> Back to Start
                </button>
            </div>
        </div>

        <div class="flex-1 flex flex-col relative">
            <div class="h-16 border-b border-gray-100 flex items-center justify-between px-6 bg-white/80 backdrop-blur-sm sticky top-0 z-10">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white shadow-sm">
                        <i class="fa-solid fa-robot text-sm"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 text-sm">AI Tutor</h3>
                        <div class="flex items-center gap-1.5">
                            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                            <span class="text-xs text-gray-400">Online</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth pb-24">
                <div class="flex justify-start fade-in">
                    <div class="bg-gray-100 rounded-2xl rounded-tl-none py-3 px-5 text-gray-700 max-w-[85%]">
                        Hello! I'm ready to help you plan your studies. What subject are we tackling today?
                    </div>
                </div>
            </div>

            <div class="absolute bottom-0 left-0 w-full bg-white p-4 border-t border-gray-100">
                <div class="max-w-3xl mx-auto relative flex gap-3 items-end">
                    <div class="flex-1 bg-gray-100 rounded-2xl flex items-center px-4 py-3 focus-within:ring-2 focus-within:ring-blue-500/50 transition border border-transparent focus-within:border-blue-500 focus-within:bg-white">
                        <textarea id="user-input" rows="1"
                            class="w-full bg-transparent border-none focus:ring-0 resize-none max-h-32 text-gray-700 placeholder-gray-400 leading-relaxed"
                            placeholder="Type your message..."
                            oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                            onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>
                    </div>
                    <button onclick="sendMessage()" class="bg-gray-900 hover:bg-black text-white w-12 h-12 rounded-xl flex items-center justify-center transition shadow-md hover:scale-105 active:scale-95 flex-shrink-0">
                        <i class="fa-solid fa-paper-plane text-sm"></i>
                    </button>
                </div>
                <div class="text-center text-xs text-gray-300 mt-2">AI can make mistakes. Please verify important information.</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://pathfinder-swgh.onrender.com"; // Render URL
        let currentThreadId = null;

        // --- CORE FUNCTIONS ---

        function startChat(initialMessage = "") {
            document.getElementById('intro-screen').classList.add('hidden');
            document.getElementById('app-interface').classList.remove('hidden');
            currentThreadId = "session_" + Date.now();

            if (initialMessage) {
                document.getElementById('user-input').value = initialMessage;
                sendMessage();
            }
        }

        async function sendMessage(manualText = null) {
            const inputEl = document.getElementById('user-input');
            const text = manualText || inputEl.value.trim();

            if (!text) return;

            // 1. UI: Show User Message
            appendMessage('user', text);
            if (!manualText) {
                inputEl.value = '';
                inputEl.style.height = 'auto';
            }

            // 2. UI: Show Loading
            const loadingId = showLoading();

            try {
                // 3. API Call
                const response = await fetch(`${API_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: text,
                        thread_id: currentThreadId
                    })
                });

                const data = await response.json();
                removeLoading(loadingId);

                if (data.status === 'error') {
                    appendMessage('bot', `‚ö†Ô∏è **Error:** ${data.reply || "Something went wrong."}`);
                    return;
                }

                // 4. Handle Response Types
                // ∆Øu ti√™n hi·ªÉn th·ªã Text tr∆∞·ªõc
                if (data.reply) {
                    const msgId = appendMessage('bot', data.reply);

                    // Logic m·ªõi: Lu√¥n hi·ªán n√∫t g·ª£i √Ω sau m·ªói tin nh·∫Øn text d√†i (gi·∫£ ƒë·ªãnh l√† plan)
                    // ƒë·ªÉ user t·ª± ch·ªçn b∆∞·ªõc ti·∫øp theo
                    if (data.reply.length > 100) {
                        appendActionButtons(msgId);
                    }
                }

                // N·∫øu user ƒë√£ b·∫•m n√∫t xin Roadmap, server tr·∫£ v·ªÅ plan -> v·∫Ω lu√¥n
                if (data.plan && (text.toLowerCase().includes('roadmap') || text.toLowerCase().includes('map') || text.toLowerCase().includes('visual'))) {
                    renderMermaid(data.plan.mermaid || data.plan.markdown);
                }

                // N·∫øu user ƒë√£ b·∫•m n√∫t xin Quiz -> hi·ªán quiz lu√¥n
                if (data.quiz) {
                    renderQuiz(data.quiz);
                }

            } catch (error) {
                removeLoading(loadingId);
                appendMessage('bot', "üîå Server connection failed. Please try again.");
                console.error(error);
            }
        }

        // --- UI RENDERING ---

        function appendMessage(sender, text) {
            const container = document.getElementById('chat-container');
            const id = 'msg-' + Date.now();

            const div = document.createElement('div');
            div.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} fade-in group`;
            div.id = id;

            const bubble = document.createElement('div');
            bubble.className = sender === 'user'
                ? 'bg-blue-600 text-white rounded-2xl rounded-tr-none py-3 px-5 max-w-[85%] shadow-md'
                : 'bg-white border border-gray-100 text-gray-800 rounded-2xl rounded-tl-none py-4 px-6 max-w-[90%] shadow-sm prose prose-sm';

            if (sender === 'bot') {
                bubble.innerHTML = marked.parse(text);
            } else {
                bubble.innerText = text;
            }

            div.appendChild(bubble);
            container.appendChild(div);
            scrollToBottom();
            return id;
        }

        // Th√™m n√∫t h√†nh ƒë·ªông v√†o d∆∞·ªõi tin nh·∫Øn c·ªßa Bot
        function appendActionButtons(parentId) {
            const parent = document.getElementById(parentId);
            const wrapper = document.createElement('div');
            wrapper.className = "flex flex-wrap gap-2 mt-3 ml-2";

            const btnMap = document.createElement('button');
            btnMap.className = "flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 rounded-full text-xs font-semibold hover:bg-blue-100 transition border border-blue-100";
            btnMap.innerHTML = `<i class="fa-solid fa-diagram-project"></i> Generate Roadmap`;
            btnMap.onclick = () => {
                // X√≥a n√∫t sau khi b·∫•m ƒë·ªÉ tr√°nh spam
                wrapper.remove();
                sendMessage("Visualize the above plan as a detailed mermaid mindmap");
            };

            const btnQuiz = document.createElement('button');
            btnQuiz.className = "flex items-center gap-2 px-4 py-2 bg-purple-50 text-purple-600 rounded-full text-xs font-semibold hover:bg-purple-100 transition border border-purple-100";
            btnQuiz.innerHTML = `<i class="fa-solid fa-list-check"></i> Take a Quiz`;
            btnQuiz.onclick = () => {
                wrapper.remove();
                sendMessage("Create a multiple choice quiz based on the above plan to test my understanding");
            };

            wrapper.appendChild(btnMap);
            wrapper.appendChild(btnQuiz);
            parent.appendChild(wrapper);
            scrollToBottom();
        }

        function renderMermaid(code) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = "flex justify-center fade-in w-full my-4";

            div.innerHTML = `
                <div class="bg-white p-2 rounded-xl shadow-lg border border-gray-200 w-full overflow-hidden relative group">
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition">
                        <span class="bg-gray-100 text-xs px-2 py-1 rounded">Visual Map</span>
                    </div>
                    <div class="mermaid flex justify-center p-4 overflow-x-auto">
                        ${code}
                    </div>
                </div>
            `;

            container.appendChild(div);
            scrollToBottom();

            // Re-run mermaid
            if (window.mermaid) {
                window.mermaid.contentLoaded();
            }
        }

        function renderQuiz(quizContent) {
            // ƒê√¥i khi quizContent l√† JSON object, ƒë√¥i khi l√† text markdown
            // Ta x·ª≠ l√Ω ƒë∆°n gi·∫£n b·∫±ng c√°ch hi·ªÉn th·ªã Markdown
            let textToShow = quizContent;
            if (typeof quizContent === 'object') {
                textToShow = JSON.stringify(quizContent, null, 2);
            }

            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = "flex justify-start fade-in w-full my-4";

            div.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-purple-500 w-full max-w-2xl">
                    <h3 class="text-purple-700 font-bold mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-puzzle-piece"></i> Knowledge Check
                    </h3>
                    <div class="prose prose-sm text-gray-700">
                        ${marked.parse(textToShow)}
                    </div>
                    <div class="mt-4 text-xs text-gray-400 italic">
                        Reply with your answers (e.g., "1A, 2B") to get feedback.
                    </div>
                </div>
            `;
            container.appendChild(div);
            scrollToBottom();
        }

        // --- UTILS ---

        function showLoading() {
            const container = document.getElementById('chat-container');
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex justify-start fade-in";
            div.innerHTML = `
                <div class="bg-white border border-gray-100 py-3 px-4 rounded-2xl rounded-tl-none shadow-sm flex items-center gap-2">
                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce delay-75"></div>
                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce delay-150"></div>
                </div>
            `;
            container.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
        }

        function resetChat() {
            if(confirm("Clear conversation history?")) {
                document.getElementById('chat-container').innerHTML = '';
                startChat();
            }
        }
    </script>
</body>
</html>s